<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Fichaje Laboral</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        /* [MANTENER TODO EL CSS IGUAL] */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #9b59b6;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
            --vacation: #3498db;
            --sick: #e67e22;
            --travel: #1abc9c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.2rem;
        }

        .logo h1 {
            font-size: 1.8rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 15px;
            border-radius: 50px;
        }

        .tabs {
            display: flex;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 18px 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            min-width: 200px;
        }

        .tab:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .tab.active {
            color: var(--secondary);
            border-bottom: 3px solid var(--secondary);
            background-color: rgba(52, 152, 219, 0.05);
        }

        .tab-content {
            display: none;
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .employee-selector {
            margin-bottom: 30px;
        }

        .selector-container {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        select, input {
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 1rem;
            background-color: white;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .clock-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .current-time {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .current-date {
            font-size: 1.3rem;
            color: var(--gray);
            margin-bottom: 30px;
        }

        .punch-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .punch-btn {
            padding: 18px 35px;
            font-size: 1.1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            min-width: 200px;
            justify-content: center;
        }

        .entry-btn {
            background-color: var(--success);
            color: white;
        }

        .exit-btn {
            background-color: var(--danger);
            color: white;
        }

        .punch-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .punch-btn:disabled {
            background-color: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .special-records {
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 40px;
        }

        .special-records h3 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .special-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .special-btn {
            padding: 15px 25px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 200px;
            justify-content: center;
        }

        .vacation-btn {
            background-color: var(--vacation);
            color: white;
        }

        .sickleave-btn {
            background-color: var(--sick);
            color: white;
        }

        .travel-btn {
            background-color: var(--travel);
            color: white;
        }

        .special-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .special-btn:disabled {
            background-color: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .manual-entry {
            background-color: #f0f7ff;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 40px;
        }

        .manual-entry h3 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .manual-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .input-group {
            flex: 1;
            min-width: 200px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 1rem;
        }

        .hours-summary {
            background-color: var(--light);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .summary-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .hours-total {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .hours-detail {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-item {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
        }

        .detail-label {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .detail-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }

        .recent-records h3 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .records-table th, .records-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .records-table th {
            background-color: var(--light);
            font-weight: 600;
            color: var(--primary);
        }

        .records-table tr:hover {
            background-color: #f9f9f9;
        }

        .record-type {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .type-entry {
            background-color: rgba(39, 174, 96, 0.15);
            color: var(--success);
        }

        .type-exit {
            background-color: rgba(231, 76, 60, 0.15);
            color: var(--danger);
        }

        .type-vacation {
            background-color: rgba(52, 152, 219, 0.15);
            color: var(--vacation);
        }

        .type-sick {
            background-color: rgba(230, 126, 34, 0.15);
            color: var(--sick);
        }

        .type-travel {
            background-color: rgba(26, 188, 156, 0.15);
            color: var(--travel);
        }

        .login-form {
            max-width: 500px;
            margin: 0 auto;
            padding: 40px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 1rem;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .login-btn:hover {
            background-color: #1a252f;
        }

        .admin-panel {
            display: none;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 180px;
        }

        .filter-group label {
            margin-bottom: 8px;
            font-weight: 600;
        }

        .employee-management, .vacation-management {
            background-color: #f0f7ff;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .employee-management h3, .vacation-management h3 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .employee-controls, .vacation-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .employee-list, .vacation-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .employee-card, .vacation-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--secondary);
        }

        .vacation-card {
            border-left-color: var(--vacation);
        }

        .employee-card h4, .vacation-card h4 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        .employee-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .vacation-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        footer {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 0.9rem;
            margin-top: 50px;
            border-top: 1px solid #eee;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-active {
            background-color: var(--success);
        }

        .status-inactive {
            background-color: var(--gray);
        }

        @media (max-width: 992px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .hours-detail, .vacation-summary, .employee-list {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .current-time {
                font-size: 2.5rem;
            }
            
            .punch-actions, .special-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .punch-btn, .special-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .selector-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            select {
                width: 100%;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .admin-header, .filters, .vacation-controls, .employee-controls {
                flex-direction: column;
            }
            
            .filter-group, .input-group {
                width: 100%;
            }
            
            .hours-detail, .vacation-summary, .employee-list {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .tab-content {
                padding: 20px 15px;
            }
            
            .current-time {
                font-size: 2rem;
            }
            
            .hours-total {
                font-size: 1.8rem;
            }
            
            .records-table {
                font-size: 0.9rem;
            }
            
            .records-table th, .records-table td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">
                <i class="fas fa-fingerprint"></i>
                <h1>Sistema de Fichaje Laboral</h1>
            </div>
            <div class="user-info">
                <i class="fas fa-user"></i>
                <span id="currentEmployee">No seleccionado</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="punch">Fichar Jornada</div>
            <div class="tab" data-tab="admin">Panel Administraci贸n</div>
        </div>

        <div class="employee-selector">
            <div class="selector-container">
                <select id="employeeSelect">
                    <option value="">Seleccione un empleado</option>
                </select>
                <button class="btn btn-success" id="saveEmployee">
                    <i class="fas fa-save"></i> Guardar Selecci贸n
                </button>
            </div>
        </div>

        <div id="punch-tab" class="tab-content active">
            <div class="clock-section">
                <div class="current-time" id="currentTime">--:--:--</div>
                <div class="current-date" id="currentDate">-- de -------- de ----</div>
            </div>

            <div class="punch-actions">
                <button class="punch-btn entry-btn" id="punchEntry">
                    <i class="fas fa-sign-in-alt"></i> Fichar Entrada
                </button>
                <button class="punch-btn exit-btn" id="punchExit" disabled>
                    <i class="fas fa-sign-out-alt"></i> Fichar Salida
                </button>
            </div>

            <div class="special-records">
                <h3><i class="fas fa-calendar-plus"></i> Registros Especiales</h3>
                <div class="special-controls">
                    <button class="special-btn vacation-btn" id="markVacation">
                        <i class="fas fa-umbrella-beach"></i> Marcar Vacaciones
                    </button>
                    <button class="special-btn sickleave-btn" id="markSickLeave">
                        <i class="fas fa-heartbeat"></i> Marcar Baja Laboral
                    </button>
                    <button class="special-btn travel-btn" id="markTravel">
                        <i class="fas fa-plane"></i> Marcar Viaje
                    </button>
                </div>
            </div>

            <div class="manual-entry">
                <h3><i class="far fa-calendar-alt"></i> Fecha y Hora Manual</h3>
                <div class="manual-controls">
                    <div class="input-group">
                        <label for="manualDate">Fecha</label>
                        <input type="date" id="manualDate">
                    </div>
                    <div class="input-group">
                        <label for="manualTime">Hora</label>
                        <input type="time" id="manualTime">
                    </div>
                    <div class="input-group">
                        <label for="manualType">Tipo</label>
                        <select id="manualType">
                            <option value="entry">Entrada</option>
                            <option value="exit">Salida</option>
                            <option value="vacation">Vacaciones</option>
                            <option value="sick">Baja Laboral</option>
                            <option value="travel">Viaje</option>
                        </select>
                    </div>
                    <div class="input-group" style="align-self: flex-end;">
                        <button class="btn btn-primary" id="manualPunch" style="width: 100%;">
                            <i class="fas fa-clock"></i> Registrar Manualmente
                        </button>
                    </div>
                </div>
            </div>

            <div class="hours-summary">
                <div class="summary-title">
                    <h3><i class="fas fa-chart-bar"></i> Resumen de Horas</h3>
                    <div class="hours-total" id="totalHours">0h 0m</div>
                </div>
                <div class="hours-detail">
                    <div class="detail-item">
                        <div class="detail-label">Horas Hoy</div>
                        <div class="detail-value" id="hoursToday">0h 0m</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Horas Semana</div>
                        <div class="detail-value" id="hoursWeek">0h 0m</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Horas Mes</div>
                        <div class="detail-value" id="hoursMonth">0h 0m</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">D铆as de Vacaciones</div>
                        <div class="detail-value" id="vacationDays">0</div>
                    </div>
                </div>
            </div>

            <div class="recent-records">
                <h3><i class="fas fa-history"></i> Registros Recientes</h3>
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Tipo</th>
                            <th>Descripci贸n</th>
                        </tr>
                    </thead>
                    <tbody id="recentRecordsBody"></tbody>
                </table>
            </div>
        </div>

        <div id="admin-tab" class="tab-content">
            <div id="loginForm" class="login-form">
                <h2><i class="fas fa-lock"></i> Acceso Administraci贸n</h2>
                <div class="form-group">
                    <label for="adminUser">Usuario</label>
                    <input type="text" id="adminUser" placeholder="Introduce tu usuario">
                </div>
                <div class="form-group">
                    <label for="adminPass">Contrase帽a</label>
                    <input type="password" id="adminPass" placeholder="Introduce tu contrase帽a">
                </div>
                <button class="login-btn" id="loginBtn">Acceder al Panel</button>
            </div>

            <div id="adminPanel" class="admin-panel">
                <div class="admin-header">
                    <h2><i class="fas fa-tachometer-alt"></i> Panel de Administraci贸n</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="filterEmployee">Empleado</label>
                            <select id="filterEmployee">
                                <option value="all">Todos los empleados</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterPeriod">Periodo</label>
                            <select id="filterPeriod">
                                <option value="today">Hoy</option>
                                <option value="week">Esta semana</option>
                                <option value="month">Este mes</option>
                                <option value="year">Este a帽o</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="filter-group" id="customDateRange" style="display: none;">
                            <label for="startDate">Desde - Hasta</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="date" id="startDate">
                                <input type="date" id="endDate">
                            </div>
                        </div>
                        <div class="filter-group" style="align-self: flex-end;">
                            <button class="btn btn-primary" id="applyFilters">
                                <i class="fas fa-filter"></i> Aplicar Filtros
                            </button>
                        </div>
                    </div>
                </div>

                <div class="employee-management">
                    <div class="summary-title">
                        <h3><i class="fas fa-users"></i> Gesti贸n de Empleados</h3>
                        <button class="btn btn-success" id="addEmployeeBtn">
                            <i class="fas fa-plus"></i> A帽adir Empleado
                        </button>
                    </div>
                    <div class="employee-list" id="employeeList"></div>
                </div>

                <div class="vacation-management">
                    <div class="summary-title">
                        <h3><i class="fas fa-calendar-check"></i> Gesti贸n de Vacaciones</h3>
                        <button class="btn btn-success" id="assignVacationBtn">
                            <i class="fas fa-plus"></i> Asignar Vacaciones
                        </button>
                    </div>
                    <div class="vacation-summary" id="vacationSummary"></div>
                </div>

                <div class="recent-records">
                    <div class="summary-title">
                        <h3><i class="fas fa-list-alt"></i> Registros de Fichaje</h3>
                        <button class="btn btn-warning" id="exportDataBtn">
                            <i class="fas fa-file-export"></i> Exportar Datos
                        </button>
                    </div>
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>Empleado</th>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Tipo</th>
                                <th>Descripci贸n</th>
                            </tr>
                        </thead>
                        <tbody id="adminRecordsBody"></tbody>
                    </table>
                </div>

                <div class="hours-summary">
                    <div class="summary-title">
                        <h3><i class="fas fa-chart-pie"></i> Resumen Administrativo</h3>
                        <div class="hours-total" id="adminTotalHours">0h 0m</div>
                    </div>
                    <div class="hours-detail">
                        <div class="detail-item">
                            <div class="detail-label">Total Horas Filtradas</div>
                            <div class="detail-value" id="filteredTotal">0h 0m</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Promedio por D铆a</div>
                            <div class="detail-value" id="avgPerDay">0h 0m</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">N煤mero de Registros</div>
                            <div class="detail-value" id="recordCount">0</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Empleados Activos</div>
                            <div class="detail-value" id="activeEmployees">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="employeeModalTitle">A帽adir Nuevo Empleado</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="employeeName">Nombre Completo</label>
                <input type="text" id="employeeName" placeholder="Nombre y apellidos">
            </div>
            <div class="form-group">
                <label for="employeeDni">DNI/NIE</label>
                <input type="text" id="employeeDni" placeholder="Documento de identidad">
            </div>
            <div class="form-group">
                <label for="employeeEmail">Email</label>
                <input type="email" id="employeeEmail" placeholder="correo@empresa.com">
            </div>
            <div class="form-group">
                <label for="employeeDepartment">Departamento</label>
                <select id="employeeDepartment">
                    <option value="Administraci贸n">Administraci贸n</option>
                    <option value="Ventas">Ventas</option>
                    <option value="IT">IT</option>
                    <option value="RRHH">RRHH</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Producci贸n">Producci贸n</option>
                    <option value="Log铆stica">Log铆stica</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div class="form-group">
                <label for="employeePosition">Puesto</label>
                <input type="text" id="employeePosition" placeholder="Puesto de trabajo">
            </div>
            <div class="form-group">
                <label for="employeeHireDate">Fecha de Contrataci贸n</label>
                <input type="date" id="employeeHireDate">
            </div>
            <div class="form-group">
                <label for="employeeStatus">Estado</label>
                <select id="employeeStatus">
                    <option value="active">Activo</option>
                    <option value="inactive">Inactivo</option>
                </select>
            </div>
            <input type="hidden" id="employeeId">
            <button class="btn btn-success" id="saveEmployeeBtn" style="width: 100%;">
                <i class="fas fa-save"></i> Guardar Empleado
            </button>
        </div>
    </div>

    <div id="vacationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Asignar Vacaciones</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="modalEmployee">Empleado</label>
                <select id="modalEmployee"></select>
            </div>
            <div class="form-group">
                <label for="modalYear">A帽o</label>
                <input type="number" id="modalYear" min="2023" max="2030" value="2026">
            </div>
            <div class="form-group">
                <label for="modalDays">D铆as de Vacaciones Asignados</label>
                <input type="number" id="modalDays" min="0" max="365" value="22">
            </div>
            <div class="form-group">
                <label for="modalStartDate">Fecha de Inicio (para agregar d铆as espec铆ficos)</label>
                <input type="date" id="modalStartDate">
            </div>
            <div class="form-group">
                <label for="modalEndDate">Fecha de Fin</label>
                <input type="date" id="modalEndDate">
            </div>
            <button class="btn btn-success" id="saveVacation" style="width: 100%;">
                <i class="fas fa-save"></i> Guardar Asignaci贸n
            </button>
        </div>
    </div>

    <footer>
        <p>Sistema de Fichaje Laboral &copy; 2023 - Todos los derechos reservados</p>
        <p><small>Alojado en GitHub Pages | Base de datos en Firebase</small></p>
    </footer>

    <script>
        //  CONFIGURACIN DE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDPYnqZuduPYVPu8HxvqDG0PX-Gft8MOE0",
            authDomain: "fichaje-ded3c.firebaseapp.com",
            projectId: "fichaje-ded3c",
            storageBucket: "fichaje-ded3c.firebasestorage.app",
            messagingSenderId: "920545104442",
            appId: "1:920545104442:web:48195df317ad5ac1ff9b03",
            measurementId: "G-DQ97WCF7WX"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Estado de la aplicaci贸n
        let selectedEmployee = null;
        let employees = [];
        let todayRecords = []; // Nuevo: almacena registros del d铆a en memoria
        let holidays = [
            "2026-01-01", "2026-01-06", "2026-04-14", "2026-04-15", 
            "2026-05-01", "2026-08-15", "2026-10-12", "2026-11-01", 
            "2026-12-06", "2026-12-08", "2026-12-25"
        ];

        // Inicializar la aplicaci贸n
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            updateClock();
            setInterval(updateClock, 1000);
            setupEventListeners();
            loadInitialData();
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').textContent = formatTime(now);
            const dateString = now.toLocaleDateString('es-ES', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            document.getElementById('currentDate').textContent = dateString.charAt(0).toUpperCase() + dateString.slice(1);
            
            const dateInput = document.getElementById('manualDate');
            const timeInput = document.getElementById('manualTime');
            if (!dateInput.value) dateInput.value = formatDate(now);
            if (!timeInput.value) timeInput.value = formatTime(now);
        }

        function setupEventListeners() {
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Empleado
            document.getElementById('saveEmployee').addEventListener('click', saveEmployeeSelection);
            document.getElementById('employeeSelect').addEventListener('change', async function() {
                selectedEmployee = this.value;
                if (selectedEmployee) {
                    localStorage.setItem('selectedEmployee', selectedEmployee);
                    updateCurrentEmployeeDisplay();
                    await updateUI();
                }
            });
            
            // Fichaje
            document.getElementById('punchEntry').addEventListener('click', punchEntry);
            document.getElementById('punchExit').addEventListener('click', punchExit);
            document.getElementById('markVacation').addEventListener('click', markAsVacation);
            document.getElementById('markSickLeave').addEventListener('click', markAsSickLeave);
            document.getElementById('markTravel').addEventListener('click', markAsTravel);
            document.getElementById('manualPunch').addEventListener('click', manualPunch);
            
            // Admin
            document.getElementById('loginBtn').addEventListener('click', adminLogin);
            document.getElementById('filterPeriod').addEventListener('change', toggleCustomDateRange);
            document.getElementById('applyFilters').addEventListener('click', applyAdminFilters);
            document.getElementById('addEmployeeBtn').addEventListener('click', showEmployeeModal);
            document.getElementById('assignVacationBtn').addEventListener('click', showVacationModal);
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('saveEmployeeBtn').addEventListener('click', saveEmployee);
            document.getElementById('saveVacation').addEventListener('click', saveVacationAssignment);
            
            // Modales
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', closeAllModals);
            });
            
            document.getElementById('employeeModal').addEventListener('click', function(e) {
                if (e.target === this) closeAllModals();
            });
            
            document.getElementById('vacationModal').addEventListener('click', function(e) {
                if (e.target === this) closeAllModals();
            });
            
            // Fechas por defecto
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            document.getElementById('modalYear').value = today.getFullYear();
            document.getElementById('modalStartDate').value = formatDate(today);
            document.getElementById('modalEndDate').value = formatDate(nextWeek);
            document.getElementById('employeeHireDate').value = formatDate(today);
        }

        async function loadInitialData() {
            try {
                console.log("Cargando datos iniciales...");
                await loadEmployees();
                const savedEmployee = localStorage.getItem('selectedEmployee');
                if (savedEmployee) {
                    // Verificar que el empleado guardado a煤n existe
                    const employeeExists = employees.some(e => e.id === savedEmployee);
                    if (employeeExists) {
                        selectedEmployee = savedEmployee;
                        document.getElementById('employeeSelect').value = savedEmployee;
                        updateCurrentEmployeeDisplay();
                        await updateUI();
                    } else {
                        localStorage.removeItem('selectedEmployee');
                        selectedEmployee = null;
                    }
                }
            } catch (error) {
                console.error("Error cargando datos iniciales:", error);
                alert("Error al cargar datos. Por favor, recarga la p谩gina.");
            }
        }

        async function loadEmployees() {
            try {
                console.log("Cargando empleados...");
                const snapshot = await db.collection('employees').get();
                
                employees = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    employees.push({ 
                        id: doc.id, 
                        ...data,
                        name: data.name || 'Sin nombre',
                        status: data.status || 'active'
                    });
                });
                
                console.log(`${employees.length} empleados cargados`);
                
                // Ordenar por nombre
                employees.sort((a, b) => a.name.localeCompare(b.name));
                
                updateEmployeeSelect();
                updateEmployeeList();
                updateModalEmployeeSelect();
                
            } catch (error) {
                console.error("Error cargando empleados:", error);
                alert("Error al cargar la lista de empleados. Verifica tu conexi贸n.");
            }
        }

        function updateEmployeeSelect() {
            const select = document.getElementById('employeeSelect');
            const filterSelect = document.getElementById('filterEmployee');
            
            // Guardar valor seleccionado actual
            const currentValue = select.value;
            const filterCurrentValue = filterSelect.value;
            
            // Limpiar opciones
            select.innerHTML = '<option value="">Seleccione un empleado</option>';
            filterSelect.innerHTML = '<option value="all">Todos los empleados</option>';
            
            // Filtrar solo empleados activos para el selector principal
            const activeEmployees = employees.filter(e => e.status === 'active');
            
            activeEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = employee.name;
                select.appendChild(option.cloneNode(true));
                filterSelect.appendChild(option);
            });
            
            // Restaurar selecci贸n si existe
            if (currentValue && activeEmployees.some(e => e.id === currentValue)) {
                select.value = currentValue;
            }
            if (filterCurrentValue && (filterCurrentValue === 'all' || employees.some(e => e.id === filterCurrentValue))) {
                filterSelect.value = filterCurrentValue;
            }
        }

        function updateModalEmployeeSelect() {
            const select = document.getElementById('modalEmployee');
            select.innerHTML = '';
            employees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = employee.name;
                select.appendChild(option);
            });
        }

        function updateEmployeeList() {
            const container = document.getElementById('employeeList');
            container.innerHTML = '';
            
            if (employees.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: var(--gray);">
                        No hay empleados registrados. Haz clic en "A帽adir Empleado" para comenzar.
                    </div>
                `;
                return;
            }
            
            employees.forEach(employee => {
                const hireDate = employee.hireDate ? new Date(employee.hireDate).toLocaleDateString('es-ES') : 'No especificada';
                const card = document.createElement('div');
                card.className = 'employee-card';
                card.innerHTML = `
                    <h4>${employee.name}</h4>
                    <p><strong>DNI/NIE:</strong> ${employee.dni || 'No especificado'}</p>
                    <p><strong>Departamento:</strong> ${employee.department || 'No especificado'}</p>
                    <p><strong>Puesto:</strong> ${employee.position || 'No especificado'}</p>
                    <p><strong>Contrataci贸n:</strong> ${hireDate}</p>
                    <p><strong>Estado:</strong> <span class="status-indicator ${employee.status === 'active' ? 'status-active' : 'status-inactive'}"></span>
                    ${employee.status === 'active' ? 'Activo' : 'Inactivo'}</p>
                    <div class="employee-actions">
                        <button class="btn btn-primary btn-edit" data-id="${employee.id}">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-danger btn-delete" data-id="${employee.id}">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
            
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    editEmployee(this.getAttribute('data-id'));
                });
            });
            
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteEmployeeConfirm(this.getAttribute('data-id'));
                });
            });
        }

        function updateCurrentEmployeeDisplay() {
            if (!selectedEmployee) {
                document.getElementById('currentEmployee').textContent = 'No seleccionado';
                return;
            }
            const employee = employees.find(e => e.id === selectedEmployee);
            document.getElementById('currentEmployee').textContent = employee ? employee.name : 'No seleccionado';
        }

        // Funciones de utilidad
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function formatHours(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = Math.floor(minutes % 60);
            return `${hours}h ${mins}m`;
        }

        function isWeekend(dateString) {
            const date = new Date(dateString);
            return date.getDay() === 0 || date.getDay() === 6;
        }

        function isHoliday(dateString) {
            return holidays.includes(dateString);
        }

        // FUNCIONES DE FICHAJE CORREGIDAS - SIN CONDICIN DE CARRERA
        async function punchEntry() {
            if (!selectedEmployee) {
                alert(' Seleccione un empleado primero');
                return;
            }
            
            const now = new Date();
            const employee = employees.find(e => e.id === selectedEmployee);
            
            try {
                const today = formatDate(now);
                
                // 1. DESHABILITAR ENTRADA Y HABILITAR SALIDA INMEDIATAMENTE
                document.getElementById('punchEntry').disabled = true;
                document.getElementById('punchExit').disabled = false;
                
                // 2. AGREGAR REGISTRO LOCALMENTE
                const localRecord = {
                    employeeId: selectedEmployee,
                    employeeName: employee.name,
                    date: today,
                    time: formatTime(now),
                    type: 'entry',
                    description: 'Entrada normal',
                    hours: 0,
                    timestamp: now.getTime(),
                    localId: 'local_' + Date.now() // ID temporal
                };
                
                // Agregar a todayRecords
                todayRecords.push(localRecord);
                todayRecords.sort((a, b) => b.timestamp - a.timestamp);
                
                // 3. ACTUALIZAR UI INMEDIATAMENTE (sin consultar Firestore)
                updateCurrentEmployeeDisplay();
                updateRecentRecordsFromLocal();
                
                // 4. GUARDAR EN FIRESTORE (en segundo plano)
                await addRecord({
                    ...localRecord,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 5. ACTUALIZAR RESUMEN DESPUS DE UN BREVE RETRASO
                setTimeout(async () => {
                    await updateHoursSummary();
                    await updateRecentRecords();
                }, 1000);
                
                alert(' Entrada registrada a las ' + formatTime(now));
            } catch (error) {
                console.error("Error registrando entrada:", error);
                alert(' Error al registrar entrada: ' + error.message);
                // Revertir estado de botones en caso de error
                document.getElementById('punchEntry').disabled = false;
                document.getElementById('punchExit').disabled = true;
            }
        }

        async function punchExit() {
            if (!selectedEmployee) {
                alert(' Seleccione un empleado primero');
                return;
            }
            
            const now = new Date();
            const employee = employees.find(e => e.id === selectedEmployee);
            
            try {
                const today = formatDate(now);
                
                // 1. Buscar la 煤ltima entrada del d铆a
                const lastEntry = todayRecords
                    .filter(r => r.type === 'entry')
                    .sort((a, b) => b.timestamp - a.timestamp)[0];
                
                if (!lastEntry) {
                    alert(' No hay una entrada registrada para hoy.');
                    return;
                }
                
                // 2. Calcular horas trabajadas
                const entryTime = new Date(lastEntry.timestamp);
                const exitTime = now;
                const hoursWorked = Math.max(0, (exitTime - entryTime) / (1000 * 60 * 60));
                
                // 3. DESHABILITAR SALIDA Y HABILITAR ENTRADA INMEDIATAMENTE
                document.getElementById('punchEntry').disabled = false;
                document.getElementById('punchExit').disabled = true;
                
                // 4. AGREGAR REGISTRO LOCALMENTE
                const localRecord = {
                    employeeId: selectedEmployee,
                    employeeName: employee.name,
                    date: today,
                    time: formatTime(now),
                    type: 'exit',
                    description: 'Salida normal',
                    hours: hoursWorked,
                    timestamp: now.getTime(),
                    localId: 'local_' + Date.now()
                };
                
                // Agregar a todayRecords
                todayRecords.push(localRecord);
                todayRecords.sort((a, b) => b.timestamp - a.timestamp);
                
                // 5. ACTUALIZAR UI INMEDIATAMENTE
                updateCurrentEmployeeDisplay();
                updateRecentRecordsFromLocal();
                
                // 6. GUARDAR EN FIRESTORE
                await addRecord({
                    ...localRecord,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 7. ACTUALIZAR RESUMEN DESPUS DE UN BREVE RETRASO
                setTimeout(async () => {
                    await updateHoursSummary();
                    await updateRecentRecords();
                }, 1000);
                
                alert(` Salida registrada.\n憋 Horas trabajadas: ${hoursWorked.toFixed(2)}h`);
            } catch (error) {
                console.error("Error registrando salida:", error);
                alert(' Error al registrar salida: ' + error.message);
                // Revertir estado de botones en caso de error
                document.getElementById('punchEntry').disabled = true;
                document.getElementById('punchExit').disabled = false;
            }
        }

        // Funci贸n para actualizar registros recientes desde datos locales
        function updateRecentRecordsFromLocal() {
            const tbody = document.getElementById('recentRecordsBody');
            tbody.innerHTML = '';
            
            if (!selectedEmployee) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" style="text-align: center; padding: 30px; color: var(--gray);">
                    <i class="fas fa-user"></i> Seleccione un empleado
                </td>`;
                tbody.appendChild(row);
                return;
            }
            
            // Filtrar registros locales del empleado seleccionado
            const employeeRecords = todayRecords.filter(r => r.employeeId === selectedEmployee);
            const recentRecords = employeeRecords.slice(0, 10);
            
            if (recentRecords.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" style="text-align: center; padding: 30px; color: var(--gray);">
                    <i class="fas fa-inbox"></i> No hay registros
                </td>`;
                tbody.appendChild(row);
                return;
            }
            
            recentRecords.forEach(record => {
                const row = document.createElement('tr');
                
                // Formatear fecha
                let formattedDate = record.date;
                try {
                    if (record.date) {
                        const dateObj = new Date(record.date);
                        formattedDate = dateObj.toLocaleDateString('es-ES', {
                            day: '2-digit', month: '2-digit', year: 'numeric'
                        });
                    }
                } catch (e) {}
                
                // Determinar tipo y color
                let typeClass = '', typeText = '', icon = '';
                switch(record.type) {
                    case 'entry': 
                        typeClass = 'type-entry'; 
                        typeText = 'Entrada';
                        icon = '<i class="fas fa-sign-in-alt"></i>';
                        break;
                    case 'exit': 
                        typeClass = 'type-exit'; 
                        typeText = 'Salida';
                        icon = '<i class="fas fa-sign-out-alt"></i>';
                        break;
                    case 'vacation': 
                        typeClass = 'type-vacation'; 
                        typeText = 'Vacaciones';
                        icon = '<i class="fas fa-umbrella-beach"></i>';
                        break;
                    case 'sick': 
                        typeClass = 'type-sick'; 
                        typeText = 'Baja';
                        icon = '<i class="fas fa-heartbeat"></i>';
                        break;
                    case 'travel': 
                        typeClass = 'type-travel'; 
                        typeText = 'Viaje';
                        icon = '<i class="fas fa-plane"></i>';
                        break;
                }
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${record.time || '--:--'}</td>
                    <td><span class="record-type ${typeClass}">${icon} ${typeText}</span></td>
                    <td>${record.description || ''} ${record.hours > 0 ? `(${record.hours.toFixed(2)}h)` : ''}</td>
                `;
                tbody.appendChild(row);
            });
        }

        async function markAsVacation() {
            if (!selectedEmployee) {
                alert('Seleccione un empleado primero');
                return;
            }
            
            const dateInput = document.getElementById('manualDate');
            const date = dateInput.value;
            const employee = employees.find(e => e.id === selectedEmployee);
            
            try {
                const dateRecords = await getRecordsByEmployee(selectedEmployee, date, date);
                const hasRecord = dateRecords.some(r => ['vacation', 'sick', 'travel'].includes(r.type));
                
                if (hasRecord) {
                    alert('Ya hay registro para esta fecha');
                    return;
                }
                
                await addRecord({
                    employeeId: selectedEmployee,
                    employeeName: employee.name,
                    date: date,
                    time: "08:00",
                    type: 'vacation',
                    description: 'D铆a de vacaciones',
                    hours: 8,
                    timestamp: Date.now(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                const year = date.substring(0, 4);
                await updateVacationDays(selectedEmployee, year, 1, 0);
                
                await updateUI();
                alert('D铆a marcado como vacaciones');
            } catch (error) {
                console.error("Error marcando vacaciones:", error);
                alert('Error al marcar vacaciones: ' + error.message);
            }
        }

        async function markAsSickLeave() {
            if (!selectedEmployee) {
                alert('Seleccione un empleado primero');
                return;
            }
            
            const date = document.getElementById('manualDate').value;
            const employee = employees.find(e => e.id === selectedEmployee);
            
            try {
                const dateRecords = await getRecordsByEmployee(selectedEmployee, date, date);
                const hasRecord = dateRecords.some(r => ['vacation', 'sick', 'travel'].includes(r.type));
                
                if (hasRecord) {
                    alert('Ya hay registro para esta fecha');
                    return;
                }
                
                await addRecord({
                    employeeId: selectedEmployee,
                    employeeName: employee.name,
                    date: date,
                    time: "00:00",
                    type: 'sick',
                    description: 'Baja laboral',
                    hours: 0,
                    timestamp: Date.now(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await updateUI();
                alert('D铆a marcado como baja laboral');
            } catch (error) {
                console.error("Error marcando baja:", error);
                alert('Error al marcar baja: ' + error.message);
            }
        }

        async function markAsTravel() {
            if (!selectedEmployee) {
                alert('Seleccione un empleado primero');
                return;
            }
            
            const date = document.getElementById('manualDate').value;
            const employee = employees.find(e => e.id === selectedEmployee);
            
            try {
                const dateRecords = await getRecordsByEmployee(selectedEmployee, date, date);
                const hasRecord = dateRecords.some(r => ['vacation', 'sick', 'travel'].includes(r.type));
                
                if (hasRecord) {
                    alert('Ya hay registro para esta fecha');
                    return;
                }
                
                let description = 'D铆a de viaje';
                let isExtraVacation = false;
                
                if (isWeekend(date) || isHoliday(date)) {
                    description = 'D铆a de viaje (fin de semana/festivo - vacaciones extra)';
                    isExtraVacation = true;
                }
                
                await addRecord({
                    employeeId: selectedEmployee,
                    employeeName: employee.name,
                    date: date,
                    time: "08:00",
                    type: 'travel',
                    description: description,
                    hours: 8,
                    timestamp: Date.now(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                if (isExtraVacation) {
                    const year = date.substring(0, 4);
                    await updateVacationDays(selectedEmployee, year, 0, 1);
                }
                
                await updateUI();
                alert('D铆a marcado como viaje' + (isExtraVacation ? ' (vacaciones extra)' : ''));
            } catch (error) {
                console.error("Error marcando viaje:", error);
                alert('Error al marcar viaje: ' + error.message);
            }
        }

        async function manualPunch() {
            if (!selectedEmployee) {
                alert('Seleccione un empleado primero');
                return;
            }
            
            const date = document.getElementById('manualDate').value;
            const time = document.getElementById('manualTime').value;
            const type = document.getElementById('manualType').value;
            const employee = employees.find(e => e.id === selectedEmployee);
            
            try {
                let description = '';
                let hours = 0;
                
                switch(type) {
                    case 'entry': description = 'Entrada manual'; break;
                    case 'exit': 
                        description = 'Salida manual';
                        const dateRecords = await getRecordsByEmployee(selectedEmployee, date, date);
                        const entryRecord = dateRecords.find(r => r.type === 'entry');
                        if (entryRecord) {
                            const entryTime = new Date(`${date}T${entryRecord.time}`);
                            const exitTime = new Date(`${date}T${time}`);
                            hours = (exitTime - entryTime) / (1000 * 60 * 60);
                        }
                        break;
                    case 'vacation':
                        description = 'Vacaciones manual';
                        hours = 8;
                        const year = date.substring(0, 4);
                        await updateVacationDays(selectedEmployee, year, 1, 0);
                        break;
                    case 'sick': description = 'Baja laboral manual'; break;
                    case 'travel':
                        description = 'Viaje manual';
                        hours = 8;
                        if (isWeekend(date) || isHoliday(date)) {
                            description += ' (fin de semana/festivo - vacaciones extra)';
                            const travelYear = date.substring(0, 4);
                            await updateVacationDays(selectedEmployee, travelYear, 0, 1);
                        }
                        break;
                }
                
                await addRecord({
                    employeeId: selectedEmployee,
                    employeeName: employee.name,
                    date: date,
                    time: time,
                    type: type,
                    description: description,
                    hours: hours,
                    timestamp: Date.now(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await updateUI();
                alert('Registro manual guardado');
            } catch (error) {
                console.error("Error registro manual:", error);
                alert('Error al guardar registro manual: ' + error.message);
            }
        }

        // Funciones de base de datos
        async function addRecord(record) {
            try {
                console.log("Guardando registro:", record);
                await db.collection('records').add(record);
                console.log("Registro guardado exitosamente");
            } catch (error) {
                console.error("Error a帽adiendo registro:", error);
                throw error;
            }
        }

        async function getRecordsByEmployee(employeeId, startDate = null, endDate = null) {
            try {
                let query = db.collection('records')
                    .where('employeeId', '==', employeeId)
                    .orderBy('timestamp', 'desc');
                
                const snapshot = await query.get();
                let records = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    records.push({ 
                        id: doc.id, 
                        ...data,
                        timestamp: data.timestamp || Date.now()
                    });
                });
                
                // Filtrar por fecha si se especifica
                if (startDate && endDate) {
                    records = records.filter(r => {
                        const recordDate = r.date || '';
                        return recordDate >= startDate && recordDate <= endDate;
                    });
                }
                
                console.log(`Obtenidos ${records.length} registros para empleado ${employeeId}`);
                return records;
            } catch (error) {
                console.error("Error obteniendo registros:", error);
                return [];
            }
        }

        async function getAllRecords(startDate = null, endDate = null) {
            try {
                let query = db.collection('records')
                    .orderBy('timestamp', 'desc');
                
                const snapshot = await query.get();
                let records = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    records.push({ 
                        id: doc.id, 
                        ...data,
                        timestamp: data.timestamp || Date.now()
                    });
                });
                
                if (startDate && endDate) {
                    records = records.filter(r => {
                        const recordDate = r.date || '';
                        return recordDate >= startDate && recordDate <= endDate;
                    });
                }
                
                return records;
            } catch (error) {
                console.error("Error obteniendo todos los registros:", error);
                return [];
            }
        }

        async function updateVacationDays(employeeId, year, usedDays = 0, extraDays = 0) {
            try {
                const snapshot = await db.collection('vacations')
                    .where('employeeId', '==', employeeId)
                    .where('year', '==', parseInt(year))
                    .get();
                
                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    const data = doc.data();
                    await doc.ref.update({
                        usedDays: (data.usedDays || 0) + usedDays,
                        extraDays: (data.extraDays || 0) + extraDays,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    const employee = employees.find(e => e.id === employeeId);
                    await db.collection('vacations').add({
                        employeeId: employeeId,
                        employeeName: employee.name,
                        year: parseInt(year),
                        totalDays: 22,
                        usedDays: usedDays,
                        extraDays: extraDays,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } catch (error) {
                console.error("Error actualizando vacaciones:", error);
            }
        }

        async function getVacationByEmployee(employeeId, year) {
            try {
                const snapshot = await db.collection('vacations')
                    .where('employeeId', '==', employeeId)
                    .where('year', '==', parseInt(year))
                    .get();
                
                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    return { id: doc.id, ...doc.data() };
                }
                return null;
            } catch (error) {
                console.error("Error obteniendo vacaciones:", error);
                return null;
            }
        }

        async function getAllVacations() {
            try {
                const snapshot = await db.collection('vacations').get();
                let vacations = [];
                snapshot.forEach(doc => {
                    vacations.push({ id: doc.id, ...doc.data() });
                });
                return vacations;
            } catch (error) {
                console.error("Error obteniendo vacaciones:", error);
                return [];
            }
        }

        // Funciones de UI
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.getAttribute('data-tab') === tabId);
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `${tabId}-tab`);
            });
            
            if (tabId === 'admin' && document.getElementById('adminPanel').style.display !== 'none') {
                updateAdminPanel();
            }
        }

        function saveEmployeeSelection() {
            if (!selectedEmployee) {
                alert('Seleccione un empleado primero');
                return;
            }
            localStorage.setItem('selectedEmployee', selectedEmployee);
            alert('Empleado guardado en esta sesi贸n');
        }

        async function updateUI() {
            console.log("Actualizando UI...");
            updateCurrentEmployeeDisplay();
            await updateHoursSummary();
            await updateRecentRecords();
            
            if (document.getElementById('adminPanel').style.display !== 'none') {
                await updateAdminPanel();
            }
        }

        async function updateHoursSummary() {
            console.log("Actualizando resumen de horas...");
            if (!selectedEmployee) {
                document.getElementById('totalHours').textContent = '0h 0m';
                document.getElementById('hoursToday').textContent = '0h 0m';
                document.getElementById('hoursWeek').textContent = '0h 0m';
                document.getElementById('hoursMonth').textContent = '0h 0m';
                document.getElementById('vacationDays').textContent = '0';
                return;
            }
            
            try {
                const now = new Date();
                const today = formatDate(now);
                const year = now.getFullYear();
                const month = now.getMonth() + 1;
                
                // Obtener registros de Firestore
                const allRecords = await getRecordsByEmployee(selectedEmployee);
                
                // Actualizar todayRecords con datos reales de Firestore
                // (pero mantener registros locales tambi茅n)
                const firestoreTodayRecords = allRecords.filter(r => r.date === today);
                
                // Combinar registros locales y de Firestore, eliminando duplicados
                const localRecords = todayRecords.filter(r => 
                    r.employeeId === selectedEmployee && r.date === today && r.localId
                );
                
                // Crear un mapa para evitar duplicados
                const recordMap = new Map();
                
                // Agregar registros de Firestore
                firestoreTodayRecords.forEach(record => {
                    if (!record.localId) {
                        recordMap.set(record.timestamp + record.type, record);
                    }
                });
                
                // Agregar registros locales (sobrescriben si hay conflicto)
                localRecords.forEach(record => {
                    recordMap.set(record.timestamp + record.type, record);
                });
                
                // Actualizar todayRecords
                todayRecords = Array.from(recordMap.values());
                todayRecords.sort((a, b) => b.timestamp - a.timestamp);
                
                // Calcular botones de fichaje basados en todayRecords
                updatePunchButtonsFromTodayRecords();
                
                const monthRecords = allRecords.filter(r => {
                    const recordDate = new Date(r.date);
                    return recordDate.getFullYear() === year && recordDate.getMonth() + 1 === month;
                });
                
                // Calcular semana actual
                const weekRecords = allRecords.filter(r => {
                    const recordDate = new Date(r.date);
                    const now = new Date();
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startOfWeek.setHours(0, 0, 0, 0);
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    endOfWeek.setHours(23, 59, 59, 999);
                    return recordDate >= startOfWeek && recordDate <= endOfWeek;
                });
                
                const todayHours = calculateWorkHours(todayRecords);
                const weekHours = calculateWorkHours(weekRecords);
                const monthHours = calculateWorkHours(monthRecords);
                const totalHours = calculateWorkHours(allRecords);
                
                console.log(`Horas hoy: ${todayHours} minutos`);
                console.log(`Horas semana: ${weekHours} minutos`);
                console.log(`Horas mes: ${monthHours} minutos`);
                console.log(`Horas total: ${totalHours} minutos`);
                
                document.getElementById('hoursToday').textContent = formatHours(todayHours);
                document.getElementById('hoursWeek').textContent = formatHours(weekHours);
                document.getElementById('hoursMonth').textContent = formatHours(monthHours);
                document.getElementById('totalHours').textContent = formatHours(totalHours);
                
                const vacation = await getVacationByEmployee(selectedEmployee, year);
                document.getElementById('vacationDays').textContent = vacation ? vacation.usedDays : '0';
                
            } catch (error) {
                console.error("Error actualizando resumen:", error);
            }
        }

        function updatePunchButtonsFromTodayRecords() {
            console.log("Actualizando botones desde todayRecords...");
            
            if (!selectedEmployee) {
                document.getElementById('punchEntry').disabled = false;
                document.getElementById('punchExit').disabled = true;
                return;
            }
            
            // Filtrar registros del empleado seleccionado
            const employeeRecords = todayRecords.filter(r => r.employeeId === selectedEmployee);
            const entries = employeeRecords.filter(r => r.type === 'entry');
            const exits = employeeRecords.filter(r => r.type === 'exit');
            
            // Determinar si hay una entrada sin salida
            let hasOpenEntry = false;
            if (entries.length > 0) {
                // Ordenar entradas por timestamp
                const sortedEntries = [...entries].sort((a, b) => 
                    (b.timestamp || 0) - (a.timestamp || 0)
                );
                const lastEntry = sortedEntries[0];
                
                // Verificar si hay una salida despu茅s de esta entrada
                const hasExitAfter = exits.some(exit => 
                    (exit.timestamp || 0) > (lastEntry.timestamp || 0)
                );
                
                hasOpenEntry = !hasExitAfter;
            }
            
            // Actualizar estado de botones
            document.getElementById('punchEntry').disabled = hasOpenEntry;
            document.getElementById('punchExit').disabled = !hasOpenEntry;
            
            console.log(`Estado botones: Entrada ${hasOpenEntry ? 'BLOQUEADA' : 'HABILITADA'}, Salida ${!hasOpenEntry ? 'BLOQUEADA' : 'HABILITADA'}`);
        }

        function calculateWorkHours(records) {
            console.log("Calculando horas para", records.length, "registros");
            
            // Filtrar solo registros de entrada/salida
            const workRecords = records.filter(r => r.type === 'entry' || r.type === 'exit');
            
            // Ordenar por timestamp
            const sortedRecords = [...workRecords].sort((a, b) => 
                (a.timestamp || 0) - (b.timestamp || 0)
            );
            
            let totalMinutes = 0;
            let currentEntry = null;
            
            for (const record of sortedRecords) {
                if (record.type === 'entry') {
                    currentEntry = record;
                } else if (record.type === 'exit' && currentEntry) {
                    try {
                        // Calcular diferencia entre entrada y salida
                        const entryTime = new Date(currentEntry.timestamp || 
                                                 new Date(currentEntry.date + 'T' + currentEntry.time));
                        const exitTime = new Date(record.timestamp || 
                                                new Date(record.date + 'T' + record.time));
                        
                        // Solo calcular si es el mismo d铆a
                        if (entryTime.toDateString() === exitTime.toDateString()) {
                            const minutesWorked = (exitTime - entryTime) / (1000 * 60);
                            totalMinutes += Math.max(0, minutesWorked);
                        }
                        currentEntry = null;
                    } catch (error) {
                        console.error("Error calculando tiempo:", error);
                    }
                }
            }
            
            // Sumar horas de d铆as especiales (vacaciones, viajes)
            const specialDays = records.filter(r => r.type === 'vacation' || r.type === 'travel');
            totalMinutes += specialDays.length * 8 * 60; // 8 horas por d铆a
            
            console.log("Total minutos calculados:", totalMinutes);
            return totalMinutes;
        }

        async function updateRecentRecords() {
            console.log("Actualizando registros recientes...");
            const tbody = document.getElementById('recentRecordsBody');
            tbody.innerHTML = '';
            
            if (!selectedEmployee) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" style="text-align: center; padding: 30px; color: var(--gray);">
                    <i class="fas fa-user"></i> Seleccione un empleado
                </td>`;
                tbody.appendChild(row);
                return;
            }
            
            try {
                // Obtener registros de Firestore
                const records = await getRecordsByEmployee(selectedEmployee);
                const recentRecords = records.slice(0, 10);
                
                if (recentRecords.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="4" style="text-align: center; padding: 30px; color: var(--gray);">
                        <i class="fas fa-inbox"></i> No hay registros
                    </td>`;
                    tbody.appendChild(row);
                    return;
                }
                
                recentRecords.forEach(record => {
                    const row = document.createElement('tr');
                    
                    // Formatear fecha
                    let formattedDate = record.date;
                    try {
                        if (record.date) {
                            const dateObj = new Date(record.date);
                            formattedDate = dateObj.toLocaleDateString('es-ES', {
                                day: '2-digit', month: '2-digit', year: 'numeric'
                            });
                        }
                    } catch (e) {}
                    
                    // Determinar tipo y color
                    let typeClass = '', typeText = '', icon = '';
                    switch(record.type) {
                        case 'entry': 
                            typeClass = 'type-entry'; 
                            typeText = 'Entrada';
                            icon = '<i class="fas fa-sign-in-alt"></i>';
                            break;
                        case 'exit': 
                            typeClass = 'type-exit'; 
                            typeText = 'Salida';
                            icon = '<i class="fas fa-sign-out-alt"></i>';
                            break;
                        case 'vacation': 
                            typeClass = 'type-vacation'; 
                            typeText = 'Vacaciones';
                            icon = '<i class="fas fa-umbrella-beach"></i>';
                            break;
                        case 'sick': 
                            typeClass = 'type-sick'; 
                            typeText = 'Baja';
                            icon = '<i class="fas fa-heartbeat"></i>';
                            break;
                        case 'travel': 
                            typeClass = 'type-travel'; 
                            typeText = 'Viaje';
                            icon = '<i class="fas fa-plane"></i>';
                            break;
                    }
                    
                    row.innerHTML = `
                        <td>${formattedDate}</td>
                        <td>${record.time || '--:--'}</td>
                        <td><span class="record-type ${typeClass}">${icon} ${typeText}</span></td>
                        <td>${record.description || ''} ${record.hours > 0 ? `(${record.hours.toFixed(2)}h)` : ''}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                console.log(`Mostrando ${recentRecords.length} registros recientes`);
                
            } catch (error) {
                console.error("Error actualizando registros:", error);
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" style="text-align: center; padding: 30px; color: var(--danger);">
                    <i class="fas fa-exclamation-triangle"></i> Error al cargar registros
                </td>`;
                tbody.appendChild(row);
            }
        }

        // Funciones de administraci贸n
        function adminLogin() {
            const username = document.getElementById('adminUser').value;
            const password = document.getElementById('adminPass').value;
            
            if (username === 'IRISNOR' && password === 'IRISNOR2026') {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                updateAdminPanel();
            } else {
                alert('Credenciales incorrectas');
            }
        }

        function toggleCustomDateRange() {
            const period = document.getElementById('filterPeriod').value;
            document.getElementById('customDateRange').style.display = period === 'custom' ? 'flex' : 'none';
        }

        async function applyAdminFilters() {
            await updateAdminPanel();
        }

        async function updateAdminPanel() {
            await updateAdminRecords();
            await updateAdminSummary();
            await updateVacationSummary();
        }

        async function updateAdminRecords() {
            const employeeFilter = document.getElementById('filterEmployee').value;
            const periodFilter = document.getElementById('filterPeriod').value;
            
            try {
                let records = await getAllRecords();
                
                if (employeeFilter !== 'all') {
                    records = records.filter(r => r.employeeId === employeeFilter);
                }
                
                const now = new Date();
                let startDate = null, endDate = null;
                
                switch(periodFilter) {
                    case 'today': startDate = endDate = formatDate(now); break;
                    case 'week':
                        const startOfWeek = new Date(now);
                        startOfWeek.setDate(now.getDate() - now.getDay());
                        startDate = formatDate(startOfWeek);
                        const endOfWeek = new Date(startOfWeek);
                        endOfWeek.setDate(startOfWeek.getDate() + 6);
                        endDate = formatDate(endOfWeek);
                        break;
                    case 'month':
                        startDate = formatDate(new Date(now.getFullYear(), now.getMonth(), 1));
                        endDate = formatDate(new Date(now.getFullYear(), now.getMonth() + 1, 0));
                        break;
                    case 'year':
                        startDate = formatDate(new Date(now.getFullYear(), 0, 1));
                        endDate = formatDate(new Date(now.getFullYear(), 11, 31));
                        break;
                    case 'custom':
                        startDate = document.getElementById('startDate').value;
                        endDate = document.getElementById('endDate').value;
                        break;
                }
                
                if (startDate && endDate) {
                    records = records.filter(r => r.date >= startDate && r.date <= endDate);
                }
                
                const tbody = document.getElementById('adminRecordsBody');
                tbody.innerHTML = '';
                
                if (records.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="5" style="text-align: center; padding: 30px; color: var(--gray);">No hay registros</td>`;
                    tbody.appendChild(row);
                    return;
                }
                
                const displayRecords = records.slice(0, 50);
                
                displayRecords.forEach(record => {
                    const row = document.createElement('tr');
                    const dateObj = new Date(record.date);
                    const formattedDate = dateObj.toLocaleDateString('es-ES', {
                        day: '2-digit', month: '2-digit', year: 'numeric'
                    });
                    
                    let typeClass = '', typeText = '', icon = '';
                    switch(record.type) {
                        case 'entry': typeClass = 'type-entry'; typeText = 'Entrada'; icon = '<i class="fas fa-sign-in-alt"></i>'; break;
                        case 'exit': typeClass = 'type-exit'; typeText = 'Salida'; icon = '<i class="fas fa-sign-out-alt"></i>'; break;
                        case 'vacation': typeClass = 'type-vacation'; typeText = 'Vacaciones'; icon = '<i class="fas fa-umbrella-beach"></i>'; break;
                        case 'sick': typeClass = 'type-sick'; typeText = 'Baja'; icon = '<i class="fas fa-heartbeat"></i>'; break;
                        case 'travel': typeClass = 'type-travel'; typeText = 'Viaje'; icon = '<i class="fas fa-plane"></i>'; break;
                    }
                    
                    row.innerHTML = `
                        <td>${record.employeeName}</td>
                        <td>${formattedDate}</td>
                        <td>${record.time || '--:--'}</td>
                        <td><span class="record-type ${typeClass}">${icon} ${typeText}</span></td>
                        <td>${record.description || ''} ${record.hours > 0 ? `(${record.hours.toFixed(2)}h)` : ''}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                if (records.length > 50) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="5" style="text-align: center; padding: 15px; color: var(--gray); font-style: italic;">Mostrando 50 de ${records.length} registros</td>`;
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error("Error actualizando registros admin:", error);
            }
        }

        async function updateAdminSummary() {
            const employeeFilter = document.getElementById('filterEmployee').value;
            const periodFilter = document.getElementById('filterPeriod').value;
            
            try {
                let records = await getAllRecords();
                
                if (employeeFilter !== 'all') {
                    records = records.filter(r => r.employeeId === employeeFilter);
                }
                
                const now = new Date();
                let startDate = null, endDate = null;
                
                switch(periodFilter) {
                    case 'today': startDate = endDate = formatDate(now); break;
                    case 'week':
                        const startOfWeek = new Date(now);
                        startOfWeek.setDate(now.getDate() - now.getDay());
                        startDate = formatDate(startOfWeek);
                        const endOfWeek = new Date(startOfWeek);
                        endOfWeek.setDate(startOfWeek.getDate() + 6);
                        endDate = formatDate(endOfWeek);
                        break;
                    case 'month':
                        startDate = formatDate(new Date(now.getFullYear(), now.getMonth(), 1));
                        endDate = formatDate(new Date(now.getFullYear(), now.getMonth() + 1, 0));
                        break;
                    case 'year':
                        startDate = formatDate(new Date(now.getFullYear(), 0, 1));
                        endDate = formatDate(new Date(now.getFullYear(), 11, 31));
                        break;
                    case 'custom':
                        startDate = document.getElementById('startDate').value;
                        endDate = document.getElementById('endDate').value;
                        break;
                }
                
                if (startDate && endDate) {
                    records = records.filter(r => r.date >= startDate && r.date <= endDate);
                }
                
                const totalHours = calculateWorkHours(records);
                const uniqueDates = [...new Set(records.map(r => r.date))];
                const uniqueEmployees = [...new Set(records.map(r => r.employeeId))];
                
                document.getElementById('filteredTotal').textContent = formatHours(totalHours);
                document.getElementById('adminTotalHours').textContent = formatHours(totalHours);
                document.getElementById('recordCount').textContent = records.length;
                document.getElementById('activeEmployees').textContent = employees.filter(e => e.status === 'active').length;
                
                const avgPerDay = uniqueDates.length > 0 ? formatHours(totalHours / uniqueDates.length) : '0h 0m';
                document.getElementById('avgPerDay').textContent = avgPerDay;
            } catch (error) {
                console.error("Error actualizando resumen admin:", error);
            }
        }

        async function updateVacationSummary() {
            try {
                const vacations = await getAllVacations();
                const currentYear = new Date().getFullYear();
                const container = document.getElementById('vacationSummary');
                container.innerHTML = '';
                
                const employeesWithVacations = {};
                
                vacations.forEach(vacation => {
                    if (!employeesWithVacations[vacation.employeeId]) {
                        const employee = employees.find(e => e.id === vacation.employeeId);
                        if (employee) {
                            employeesWithVacations[vacation.employeeId] = {
                                name: employee.name,
                                vacations: []
                            };
                        }
                    }
                    if (employeesWithVacations[vacation.employeeId]) {
                        employeesWithVacations[vacation.employeeId].vacations.push(vacation);
                    }
                });
                
                for (const employeeId in employeesWithVacations) {
                    const employee = employeesWithVacations[employeeId];
                    const currentVacation = employee.vacations.find(v => v.year === currentYear);
                    
                    const card = document.createElement('div');
                    card.className = 'vacation-card';
                    
                    let html = `<h4>${employee.name}</h4><div>Vacaciones del a帽o ${currentYear}</div>`;
                    
                    if (currentVacation) {
                        const remainingDays = currentVacation.totalDays - currentVacation.usedDays;
                        html += `
                            <div class="vacation-stats">
                                <div class="stat"><div class="stat-value">${currentVacation.totalDays}</div><div class="stat-label">Asignados</div></div>
                                <div class="stat"><div class="stat-value">${currentVacation.usedDays}</div><div class="stat-label">Usados</div></div>
                                <div class="stat"><div class="stat-value">${currentVacation.extraDays}</div><div class="stat-label">Extra</div></div>
                                <div class="stat"><div class="stat-value" style="color: ${remainingDays >= 0 ? 'var(--success)' : 'var(--danger)'}">${remainingDays}</div><div class="stat-label">Restantes</div></div>
                            </div>
                        `;
                    } else {
                        html += `<div style="color: var(--gray); margin-top: 10px;">Sin asignaci贸n</div>`;
                    }
                    
                    card.innerHTML = html;
                    container.appendChild(card);
                }
                
                if (Object.keys(employeesWithVacations).length === 0) {
                    container.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: var(--gray);">No hay vacaciones registradas</div>`;
                }
            } catch (error) {
                console.error("Error actualizando resumen vacaciones:", error);
            }
        }

        function showEmployeeModal() {
            document.getElementById('employeeModal').style.display = 'flex';
            document.getElementById('employeeModalTitle').textContent = 'A帽adir Empleado';
            document.getElementById('employeeId').value = '';
            document.getElementById('employeeName').value = '';
            document.getElementById('employeeDni').value = '';
            document.getElementById('employeeEmail').value = '';
            document.getElementById('employeeDepartment').value = 'Administraci贸n';
            document.getElementById('employeePosition').value = '';
            document.getElementById('employeeHireDate').value = formatDate(new Date());
            document.getElementById('employeeStatus').value = 'active';
        }

        function editEmployee(employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) return;
            
            document.getElementById('employeeModal').style.display = 'flex';
            document.getElementById('employeeModalTitle').textContent = 'Editar Empleado';
            document.getElementById('employeeId').value = employeeId;
            document.getElementById('employeeName').value = employee.name || '';
            document.getElementById('employeeDni').value = employee.dni || '';
            document.getElementById('employeeEmail').value = employee.email || '';
            document.getElementById('employeeDepartment').value = employee.department || 'Administraci贸n';
            document.getElementById('employeePosition').value = employee.position || '';
            document.getElementById('employeeHireDate').value = employee.hireDate || formatDate(new Date());
            document.getElementById('employeeStatus').value = employee.status || 'active';
        }

        async function saveEmployee() {
            const employeeId = document.getElementById('employeeId').value;
            const employeeData = {
                name: document.getElementById('employeeName').value,
                dni: document.getElementById('employeeDni').value,
                email: document.getElementById('employeeEmail').value,
                department: document.getElementById('employeeDepartment').value,
                position: document.getElementById('employeePosition').value,
                hireDate: document.getElementById('employeeHireDate').value,
                status: document.getElementById('employeeStatus').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (!employeeData.name) {
                alert('El nombre es obligatorio');
                return;
            }
            
            try {
                if (employeeId) {
                    await db.collection('employees').doc(employeeId).update(employeeData);
                } else {
                    employeeData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('employees').add(employeeData);
                }
                
                closeAllModals();
                await loadEmployees();
                alert('Empleado guardado');
            } catch (error) {
                console.error("Error guardando empleado:", error);
                alert('Error al guardar empleado');
            }
        }

        async function deleteEmployeeConfirm(employeeId) {
            if (!confirm('驴Eliminar este empleado?')) return;
            
            try {
                await db.collection('employees').doc(employeeId).update({
                    status: 'inactive',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await loadEmployees();
                alert('Empleado eliminado');
            } catch (error) {
                console.error("Error eliminando empleado:", error);
                alert('Error al eliminar empleado');
            }
        }

        function showVacationModal() {
            document.getElementById('vacationModal').style.display = 'flex';
        }

        function closeAllModals() {
            document.getElementById('employeeModal').style.display = 'none';
            document.getElementById('vacationModal').style.display = 'none';
        }

        async function saveVacationAssignment() {
            const employeeId = document.getElementById('modalEmployee').value;
            const year = parseInt(document.getElementById('modalYear').value);
            const totalDays = parseInt(document.getElementById('modalDays').value);
            const startDate = document.getElementById('modalStartDate').value;
            const endDate = document.getElementById('modalEndDate').value;
            
            if (!employeeId || !year || isNaN(totalDays)) {
                alert('Complete los campos obligatorios');
                return;
            }
            
            try {
                const employee = employees.find(e => e.id === employeeId);
                const vacationData = {
                    employeeId: employeeId,
                    employeeName: employee.name,
                    year: year,
                    totalDays: totalDays,
                    usedDays: 0,
                    extraDays: 0,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Si hay fechas espec铆ficas, crear registros
                if (startDate && endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    const timeDiff = Math.abs(end.getTime() - start.getTime());
                    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;
                    
                    for (let i = 0; i < daysDiff; i++) {
                        const currentDate = new Date(start);
                        currentDate.setDate(start.getDate() + i);
                        const dateStr = formatDate(currentDate);
                        
                        await addRecord({
                            employeeId: employeeId,
                            employeeName: employee.name,
                            date: dateStr,
                            time: "08:00",
                            type: 'vacation',
                            description: 'Vacaciones asignadas',
                            hours: 8,
                            timestamp: Date.now(),
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    vacationData.usedDays = daysDiff;
                }
                
                // Buscar si ya existe
                const snapshot = await db.collection('vacations')
                    .where('employeeId', '==', employeeId)
                    .where('year', '==', year)
                    .get();
                
                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    await doc.ref.update(vacationData);
                } else {
                    vacationData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('vacations').add(vacationData);
                }
                
                closeAllModals();
                updateVacationSummary();
                alert('Vacaciones asignadas');
            } catch (error) {
                console.error("Error asignando vacaciones:", error);
                alert('Error al asignar vacaciones');
            }
        }

        async function exportData() {
            try {
                const records = await getAllRecords();
                const vacations = await getAllVacations();
                
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "SISTEMA DE FICHAJE LABORAL\n";
                csvContent += `Exportaci贸n: ${formatDate(new Date())}\n\n`;
                csvContent += "REGISTROS DE FICHAJE\nEmpleado,Fecha,Hora,Tipo,Descripci贸n,Horas\n";
                
                records.forEach(record => {
                    const row = [
                        record.employeeName,
                        record.date,
                        record.time || '',
                        record.type,
                        record.description || '',
                        record.hours || '0'
                    ].map(field => `"${field}"`).join(",");
                    csvContent += row + "\n";
                });
                
                csvContent += "\nVACACIONES\nEmpleado,A帽o,D铆as Asignados,D铆as Usados,D铆as Extra\n";
                vacations.forEach(vacation => {
                    const row = [
                        vacation.employeeName,
                        vacation.year,
                        vacation.totalDays,
                        vacation.usedDays,
                        vacation.extraDays
                    ].map(field => `"${field}"`).join(",");
                    csvContent += row + "\n";
                });
                
                csvContent += "\nEMPLEADOS\nNombre,DNI,Email,Departamento,Puesto,Contrataci贸n,Estado\n";
                employees.forEach(employee => {
                    const row = [
                        employee.name,
                        employee.dni || '',
                        employee.email || '',
                        employee.department || '',
                        employee.position || '',
                        employee.hireDate || '',
                        employee.status
                    ].map(field => `"${field}"`).join(",");
                    csvContent += row + "\n";
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `registros_${formatDate(new Date())}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error("Error exportando:", error);
                alert('Error al exportar');
            }
        }
    </script>
</body>
</html>